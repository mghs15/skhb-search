<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>SKHB検索</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<script>

const globalInfo = {
  "text": "",
  "list": [],
  "tempList": [],
  "index": {}
}

const addCard = () => {
  console.log("add");
  const selectedFile = document.getElementById('addCard').files[0];
  console.log(selectedFile);
  
  const reader = new FileReader();
  reader.onload = () => {
    
    if(!reader.result) return;
    
    globalInfo.text = reader.result;
    globalInfo.list = globalInfo.text.split(/(\r\n|\n)/g);
    
    const parent = document.getElementById('wrap');
    parent.innerHTML = "読み込み完了！（" + globalInfo.list.length + "件）";
    
    //メモリを食うっぽいので、最初は表示しない
    //renderFromList(globalInfo.list);
    
  }
  
  reader.readAsText(selectedFile, 'shift-jis');
}

const headerInfo = [
  "市町村コード",
  "都道府県名及び市町村名",
  "NO",
  "施設・場所名",
  "住所",
  "洪水",
  "崖崩れ、土石流及び地滑り",
  "高潮",
  "地震",
  "津波",
  "大規模な火事",
  "内水氾濫",
  "火山現象",
  "指定避難所との重複",
  "緯度",
  "経度",
  "備考"
];

const headerShortInfo = [
  "コード",
  "市町村名",
  "NO",
  "施設・場所名",
  "住所",
  "洪水",
  "土石",
  "高潮",
  "地震",
  "津波",
  "火事",
  "内水",
  "火山",
  "重複",
  "地図",
  "",
  "",
  "",
  ""
];

const createHeader = (array) => {
  
  let h = "<div class='table-row table-header'>";
  
  array.forEach( c => {
    if(c)  h += `<div class='cell'>${c}</div>`; // 市町村コード
  });

  h += "</div>";
  return h;
}


const createRowComp = (array) => {
  
  let row = "<div class='table-row'>";
  row += `<div class='cell'>${array[0]}</div>`; // 市町村コード
  row += `<div class='cell'>${array[1]}</div>`; // 都道府県名及び市町村名
  row += `<div class='cell'>${array[2]}</div>`; // NO
  row += `<div class='cell'>${array[3]}</div>`; // 施設・場所名
  row += `<div class='cell'>${array[4]}</div>`; // 住所
  
  let dnum = 0;
  let sc = 5; // Start Column;
  
  for(let i = sc; i < sc + 8; i++){
    if(array[i] && array[i] == "1"){
      row += `<div class='cell'><div class='disasterType'>${headerShortInfo[i]}</div></div>`;
      if(!dnum) dnum = i - sc + 1;
    }else{
      row += `<div class='cell'></div>`;
    }
  }
  
  row += `<div class='cell'>${array[13]}</div>`; // 指定避難所との重複
  
  const lat = +array[14];
  const lng = +array[15];
  
  
  const gsimapsUrl = `https://maps.gsi.go.jp/#16/${lat}/${lng}/&base=std&ls=std|skhb0${dnum}&disp=11&lcd=skhb0${dnum}&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m`;
  const disaportalUrl = `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lng}&z=16&base=pale&ls=disaster${dnum}&disp=1&vs=c1j0l0u0t0h0z0`;
  const googlmapUrl = `https://www.google.co.jp/maps/@${lat},${lng},350m/data=!3m1!1e3?hl=ja`;
  
  row += "<div class='cell map-tools'>"
  
  row += `<div class='map-link' title='地理院地図'><a href='${gsimapsUrl}' target='_blank'>GSI</a></div> / `;
  row += `<div class='map-link' title='重ねるハザードマップ'><a href='${disaportalUrl}' target='_blank'>HZM</a></div> /`;
  row += `<div class='map-link' title='GoogleMap'><a href='${googlmapUrl}' target='_blank'>GGL</a></div>`;
  row += "</div>"; // class='map-tools'
  
  row += "</div>"; // class='table-row'
  
  if(array[16]) row += `<div class='table-row-note'>※備考：${array[16]}</div>`;
  
  return row;
  
}


const renderFromList = (list) => {
  
  globalInfo.tempList = list;
  setCsv();
  
  let res = "";
  
  if(list.length < 1) res += "結果はありません。";
  
  if(list.length > 1000){
    const answer = window.confirm("結果は" + list.length + "件です。すべて表示しますか？");
    if(!answer){
      res += "一部（1000件/" + list.length + "件）のみ表示します。";
      list.splice(1000);
    }
  }else{
    res += "結果は" + list.length + "件です。";
  }
  
  res += "<div class='table'>";
  
  res += createHeader(headerShortInfo);
  
  for(i in list){
    const f = list[i];
    
    if(!f) continue;
    
    const c = f.split(",");
    
    const de = createRowComp(c);
    
    res += de;
  }
  
  res += "</div>"; // class = 'table'
  
  const parent = document.getElementById('wrap');
  parent.innerHTML = res;

}

const searchFiles = () => {
  
  
  let result = globalInfo.list;
  
  const p = document.getElementById("textSearchConditionsArea")
  const qs = p.querySelectorAll(".searchInputArea");
  
  console.log(qs);
  
  qs.forEach( q => {
    console.log(q);
    console.log(q.querySelectorAll(".target"));
  
    const target = q.querySelectorAll("select.target")[0].value;
    const words = q.querySelectorAll("input.searchWord")[0].value;
    const inout = q.querySelectorAll("select.inout")[0].value;
    console.log(target, words, inout);
    
    let num;
    let searchWord = "";
    let excludeWords = "";
    
    if(target && target != "all"){
      num = + target;
    }else{
      num = null;
    }
    
    if(inout == "out"){
      excludeWords = words;
    }else{
      searchWord = words;
    }
    
    result = searchList(result, num, searchWord, excludeWords);
    
  });
  
  const isDtypeOnly = document.getElementById("onlyDtype").checked;
  if(isDtypeOnly){
    let sc = 5;
    if(document.getElementById("d01").checked) result = result.filter(f => (f.split(",")[sc+0] == "1"));
    if(document.getElementById("d02").checked) result = result.filter(f => (f.split(",")[sc+1] == "1"));
    if(document.getElementById("d03").checked) result = result.filter(f => (f.split(",")[sc+2] == "1"));
    if(document.getElementById("d04").checked) result = result.filter(f => (f.split(",")[sc+3] == "1"));
    if(document.getElementById("d05").checked) result = result.filter(f => (f.split(",")[sc+4] == "1"));
    if(document.getElementById("d06").checked) result = result.filter(f => (f.split(",")[sc+5] == "1"));
    if(document.getElementById("d07").checked) result = result.filter(f => (f.split(",")[sc+6] == "1"));
    if(document.getElementById("d08").checked) result = result.filter(f => (f.split(",")[sc+7] == "1"));
  }
  
  
  renderFromList(result);
  
}

const searchList = (list, num, searchWords, excludeWords) => {

  let isTargetColumnOnly = false;
  if(num && num > -1){
    isTargetColumnOnly = true;
  }
  
  let result = list.filter(f => f.match(/\S/));
  
  const word = searchWords;
  const words = word.split(/(\s|　)/g);
  
  console.log(num, result[0].split(",")[num]);
  
  words.forEach( w => {
    if( !w || w == "　" || !w.match(/\S/)) return;
    if(isTargetColumnOnly){
      result = result.filter(f => f.split(",")[num].match(w));
    }else{
      result = result.filter(f => f.match(w));
    }
  });
  
  
  const outword = excludeWords;
  const outwords = outword.split(/(\s|　)/g);
  
  if(outwords && outwords.length > 0){
    outwords.forEach( w => {
      if( !w || w == "　" || !w.match(/\S/)) return;
    if(isTargetColumnOnly){
      result = result.filter(f => !f.split(",")[num].match(w));
    }else{
      result = result.filter(f => !f.match(w));
    }
    });
  }
  
  console.log(words);
  console.log(outwords);
  
  return result;
  
}

setCsv = () => {
  
  let res = headerInfo.join(",");
  globalInfo.tempList.forEach( line => {
    res += line + "\r\n";
  });
  const blob = new Blob([res], {type: 'text\/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.getElementById('download');
  a.href = window.URL.createObjectURL(blob);
  a.download = "skhb.csv";
  
}


const addInputArea = () => {
  
  const id = Math.random + "-" + Date.now();
  
  const template = `
      <select class="target">
        <option value="all">全体</option>
        <option value="0">コード</option>
        <option value="1">市町村名</option>
        <option value="2">NO</option>
        <option value="3">施設・場所名</option>
        <option value="4">住所</option>
        <option value="5">洪水</option>
        <option value="6">土石</option>
        <option value="7">高潮</option>
        <option value="8">地震</option>
        <option value="9">津波</option>
        <option value="10">火事</option>
        <option value="11">内水</option>
        <option value="12">火山</option>
        <option value="13">重複</option>
        <option value="14">緯度</option>
        <option value="15">経度</option>
        <option value="16">備考</option>
      </select>
      に<input type="text" class="searchWord" size="50">を
      <select class="inout">
        <option value="in">含む</option>
        <option value="out">含まない</option>
      </select>
      <button id="searchButton" onClick="removeElement('${id}');">削除</button>`;
  
  const child = document.createElement('div');
  child.id = id;
  child.classList.add("searchInputArea");
  child.classList.add("textSearchCondition");
  child.innerHTML = template;
  
  const p = document.getElementById("textSearchConditionsArea");
  p.appendChild(child);

}

const removeElement = (id) => {
  const el = document.getElementById(id);
  el.remove();
}

</script>

<style>
body{
}


#title {
  background-color: #000000;
  color: #FFFFFF;
  border-radius: 4px;
  margin: 8px;
  padding: 4px;
}
 
#abstruct {
  margin: 8px;
  padding: 4px;
}

#note {
  margin: 8px;
  padding: 4px;
  color: #FF0000;
}

#info {
  margin: 8px;
  padding: 4px;
}

.searchInputArea {
  border-radius: 4px;
  border: solid 1px #EEEEEE;
  padding: 4px;
  margin: 2px;
}

#infoSearchButtonArea {
  padding: 4px;
  margin: 2px;
}

#wrap {
  margin: 8px;
  padding: 4px;
}


#wrap .table {
  display: grid;
}

.table-row {
  display: grid;
  grid-template-columns: 60px 120px 50px minmax(150px, 1fr) minmax(150px, 1fr) 20px 20px 20px 20px 20px 20px 20px 20px 20px 100px;
}

.table-header {
}

.table-row-note {
  display: grid;
  padding-left: 2em;
}

.cell {
  display: inline-block;
  padding: 2px;
  border: solid 1px #AAAAAA;
}

.disasterType {
  display: inline-block;
  font-size: 0.8em;
  border-radius: 0.2em;
  background-color: #EEEEEE;
  text-align: center
}

.map-tools div {
  display: inline-block;
}

.map-link {
  text-align: center
}

.map-move {
  cursor: pointer;
}

#info div {
  padding-bottom: 4px;
}

#map {
}

#refelence {
  background-color: #EEEEEE;
  text-align: center
}

.popup-content .table-row {
  display: grid;
  grid-template-columns: 1fr;
}

</style>

</head>
<body>

<div id="overlayLargeImageSpace"></div>
<div id="overlayLock"></div>
<div id="page">
  <div id="title">
  指定緊急避難場所　簡易検索サイト（個人サイト）
  </div>
  <div id="abstruct">
  国土地理院が提供している<a href="https://www.gsi.go.jp/bousaichiri/hinanbasho.html" target="_blank">指定緊急避難場所のCSVデータ</a>を取り込んで、中身を簡易的に検索をするサイトです。
  地図付きは<a href="./index-with-map.html">こちら</a>。
  <br>
  本サイトは個人サイトです。国土地理院その他の組織とは関係ございません。
  </div>
  <div id="note">
  ※試験中です。誤った結果が出力されることもありますので、ご注意ください。
  </div>
  <div id="info">
    
    <div id="infoAddCardButton" class="searchInputArea">
      CSVデータ：
      <input type="file" id="addCard" onChange="addCard();">
      ※お手持ちのCSVデータを取り込んでください。
    </div>
    
    <hr>
    
    <div id="textSearchConditionsArea">
      <div id="defaultTextSearchCond" class="searchInputArea textSearchCondition">
        <select class="target">
          <option value="all">全体</option>
          <option value="0">コード</option>
          <option value="1">市町村名</option>
          <option value="2">NO</option>
          <option value="3">施設・場所名</option>
          <option value="4">住所</option>
          <option value="5">洪水</option>
          <option value="6">土石</option>
          <option value="7">高潮</option>
          <option value="8">地震</option>
          <option value="9">津波</option>
          <option value="10">火事</option>
          <option value="11">内水</option>
          <option value="12">火山</option>
          <option value="13">重複</option>
          <option value="14">緯度</option>
          <option value="15">経度</option>
          <option value="16">備考</option>
        </select>
        に<input type="text" class="searchWord" size="50">を
        <select class="inout">
          <option value="in">含む</option>
          <option value="out">含まない</option>
        </select>
        <button id="searchButton" onClick="removeElement('defaultTextSearchCond');">削除</button>
      </div>
    </div>
    
    <div id="infoSearchButtonArea">
      検索条件を増やす：<button id="searchButton" onClick="addInputArea();">＋</button>
    </div>
    
    <div id="searchInputArea4" class="searchInputArea dtypeSearchCondition">
      <input type="checkbox" id="onlyDtype" name="onlyDtype" checked="checked" >種別で絞る
      　→　種別選択：
      <input type="checkbox" id="d01" name="d01" >洪水
      <input type="checkbox" id="d02" name="d02" >土砂
      <input type="checkbox" id="d03" name="d03" >高潮
      <input type="checkbox" id="d04" name="d04" >地震
      <input type="checkbox" id="d05" name="d05" >津波
      <input type="checkbox" id="d06" name="d06" >火事
      <input type="checkbox" id="d07" name="d07" >内水
      <input type="checkbox" id="d08" name="d08" >火山
    </div>
    
    
    <div id="infoSearchButtonArea">
      <button id="searchButton" onClick="searchFiles();">絞り込み</button>
      <a id="download" target="_blank">CSV出力</a>
    </div>
    
  </div>
  
  
  <div id="map"></div>
  
  
  <div id="wrap">
  </div>
</div>

<div id="refelence">
  <a href="https://www.gsi.go.jp/bousaichiri/hinanbasho.html">指定緊急避難場所（国土地理院）</a> |
</div>

<script>

</script>

</body>
</html>


